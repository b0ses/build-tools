- import_playbook: setup_droplet.yml
- name: Configure droplet for Custum Stream Dashboard
  hosts: custom-stream-overlay
  remote_user: root
  become_method: sudo

  vars:
    secret_key: "{{ lookup('env', 'SECRET_KEY') }}"

  tasks:

    - name: remove git directory if exists
      file:
        path: /git
        state: absent

    - name: make git directory
      file:
        path: /git
        state: directory
        mode: 0755

    # CUSTOM STREAM API
    - name: install pip3
      apt:
        name: python3-pip
        update_cache: yes

    - name: make clone directory
      file:
        path: /git/custom-stream-api
        state: directory

    - name: git custom stream API
      git:
        repo: "https://github.com/b0ses/custom-stream-api.git"
        dest: /git/custom-stream-api

    - name: install custom stream API's dependencies
      pip:
        requirements: /git/custom-stream-api/requirements.txt

    - name: populate secret key
      lineinfile:
          path: /git/custom-stream-api/settings.py
          regexp: "^SECRET = ''"
          line: "SECRET = '{{ secret_key }}'"

    # CUSTOM STREAM OVERLAY
    - name: Download nodejs 8 installer
      get_url: url=https://deb.nodesource.com/setup_8.x dest=/tmp/nodejs8-installer.sh
      mode: 0700

    - name: Execute the nodejs8-installer.sh
      shell: /tmp/nodejs8-installer.sh

    - name: Remove the nodejs8-installer.sh
      file: path=/tmp/nodejs8-installer.sh state=absent

    - name: install nodejs
      apt:
        name: nodejs

    - name: install npm
      apt:
        name: npm
        update_cache: yes

    - name: make clone directory
      file:
        path: /git/custom-stream-overlay
        state: directory

    - name: git custom stream overlay
      git:
        repo: "https://github.com/b0ses/custom-stream-overlay.git"
        dest: /git/custom-stream-overlay

    - name: Install packages based on package.json.
      npm:
        path: /git/custom-stream-overlay

    - name: Build app
      shell: npm build